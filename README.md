# 🏥 眼部健康智能系统 (Eye Health AI Suite)

![项目封面](pictures/E.png)

## 📖 项目简介

这是一个集成了**Web端眼部健康管理**和**智能桌宠陪伴**的综合性眼部健康系统。系统采用现代化技术栈，支持本地大模型推理，提供完整的眼部健康检测、训练、咨询和智能陪伴功能。

### 🌟 核心特色

- **双端集成**：Web端专业眼部健康管理 + 桌宠端智能陪伴
- **本地化部署**：完全本地运行，保护用户隐私
- **AI智能助手**：基于DeepSeek大模型的智能对话和工具调用
- **多模态交互**：Web界面、命令行、桌宠对话等多种交互方式
- **专业医疗级**：包含完整的视力检测、训练、分析功能

---

## 📋 目录

- [系统架构](#系统架构)
- [主要功能](#主要功能)
- [快速开始](#快速开始)
- [详细功能说明](#详细功能说明)
- [技术架构](#技术架构)
- [安装部署](#安装部署)
- [使用指南](#使用指南)
- [常见问题](#常见问题)
- [开发指南](#开发指南)

---

## 🏗️ 系统架构

```
眼部健康智能系统
├── 🌐 Web端 (Flask + 现代化前端)
│   ├── 实时聊天界面
│   ├── 视力检测系统
│   ├── 训练游戏中心
│   ├── 数据分析面板
│   └── 健康咨询模块
│
└── 🐱 桌宠端 (PyQt6 + AI工具链)
    ├── 智能桌宠PepperCat
    ├── 眼部健康游戏集成
    ├── AI工具链系统
    ├── 网络对战功能
    └── 自然语言交互
```

---

## 🚀 主要功能

### 🌐 Web端功能

#### 1. 智能对话系统
- **自然语言交互**：与AI助手进行自然对话
- **多工具自动调用**：自动识别需求并调用相应工具
- **对话历史管理**：保存和回顾历史对话
- **个性化建议**：基于用户历史提供个性化建议

#### 2. 视力检测系统
- **基础视力检测**：E字表视力检测
- **高级视力检测**：
  - 色觉检测
  - 对比度敏感度测试
  - 周边视野检测
  - 眼动追踪分析
- **实时手势识别**：支持手势控制检测过程

#### 3. 视力训练游戏
- **记忆训练游戏**：训练短期记忆能力
- **专注力训练游戏**：提升视觉专注力
- **反应速度训练游戏**：训练视觉反应速度
- **眼动追踪游戏**：训练眼球运动控制

#### 4. 数据分析与报告
- **检测数据统计**：历史检测数据可视化
- **趋势分析**：视力变化趋势分析
- **个性化报告**：生成个性化健康报告
- **数据导出**：支持数据导出和分享

#### 5. 健康咨询系统
- **症状智能问诊**：基于症状的智能诊断
- **眼部图片识别**：自动识别常见眼病
- **知识库查询**：眼部健康知识库
- **风险评估**：眼部健康风险评估

### 🐱 桌宠端功能

#### 1. 智能桌宠PepperCat
- **拟人化设计**：多种心情、动作、状态动画
- **情感系统**：根据互动调整心情和状态
- **记忆系统**：记住用户偏好和互动历史
- **个性化特征**：每个桌宠都有独特性格

#### 2. 眼部健康游戏集成
- **记忆训练游戏**：记住颜色顺序并点击
- **专注力训练游戏**：在网格中找到指定数字
- **反应速度训练游戏**：快速点击彩色方块
- **自然语言启动**：通过对话启动游戏

#### 3. AI工具链系统
- **智能命令解析**：自然语言命令自动解析
- **多工具集成**：
  - WebSearchTool：联网搜索
  - FileOpsTool：文件操作
  - ReadFileTool：文件读取
  - VisualizeTool：数据可视化
  - DeepseekQATool：AI分析
- **自动化任务执行**：多步任务自动规划执行

#### 4. 网络对战系统
- **局域网对战**：多玩家实时对战
- **多种攻击技能**：火球、闪电、冰霜、弓箭
- **近战/远程模式**：支持不同战斗风格
- **实时同步**：所有战斗数据实时同步

#### 5. 交互功能
- **多种互动方式**：抚摸、喂食、玩耍、聊天
- **状态管理**：实时更新各项属性
- **动画效果**：流畅的动画和视觉效果
- **响应式界面**：支持窗口大小调整

---

## ⚡ 快速开始

### 环境要求
- **Python**: 3.8+
- **操作系统**: Windows 10/11, Ubuntu 20.04+, macOS 12+
- **硬件**: 有摄像头的PC/笔记本（推荐）

### 1. 克隆项目
```bash
git clone <repository-url>
cd eye_test_model-master
```

### 2. 安装依赖
```bash
# 安装主项目依赖
pip install -r requirements.txt

# 安装桌宠依赖
cd PepperCat-main
pip install -r requirements.txt
```

### 3. 部署本地大模型
```bash
# 安装Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 下载DeepSeek模型
ollama pull deepseek-chat

# 启动Ollama服务
ollama serve
```

### 4. 启动系统

#### 启动Web端
```bash
# 方式1：现代Web应用（推荐）
python start_web_app.py

# 方式2：智能代理系统
python run_eye_health_system.py

# 方式3：传统Web服务
python app.py
```
访问：http://localhost:5000

#### 启动桌宠端
```bash
cd PepperCat-main
python main.py
```

#### 一键启动所有服务
```bash
python start_all.py
```

---

## 📚 详细功能说明

### 🌐 Web端详细功能

#### 智能对话系统
- **实时聊天界面**：现代化的聊天界面，支持实时对话
- **多轮对话**：支持上下文理解和多轮对话
- **工具自动调用**：自动识别需求并调用相应工具
- **对话历史**：保存和回顾历史对话记录

#### 视力检测系统
- **E字表检测**：标准视力检测，支持手势识别
- **色觉检测**：色盲色弱检测
- **对比度检测**：对比度敏感度测试
- **视野检测**：周边视野检测
- **眼动追踪**：眼球运动轨迹分析

#### 训练游戏系统
- **记忆训练**：记住颜色顺序，训练短期记忆
- **专注力训练**：在网格中找到指定数字
- **反应速度训练**：快速点击目标，训练反应速度
- **眼动追踪训练**：训练眼球运动控制

#### 数据分析系统
- **检测数据统计**：历史检测数据可视化展示
- **趋势分析**：视力变化趋势分析
- **个性化报告**：生成个性化健康报告
- **数据导出**：支持CSV、JSON等格式导出

### 🐱 桌宠端详细功能

#### 智能桌宠系统
- **状态管理**：心情、精力、饥饿、健康值实时更新
- **情感系统**：根据互动调整心情和状态
- **记忆系统**：记住用户偏好和互动历史
- **个性化**：每个桌宠都有独特性格特征

#### 眼部健康游戏
- **记忆训练游戏**：记住颜色点亮顺序并点击
- **专注力训练游戏**：在3x3网格中找到指定数字
- **反应速度训练游戏**：快速点击随机出现的彩色方块
- **自然语言启动**：通过对话启动游戏

#### AI工具链系统
- **智能命令解析**：自然语言命令自动解析
- **多工具集成**：
  - 网络搜索：实时搜索信息
  - 文件操作：读写本地文件
  - 数据可视化：生成图表
  - AI分析：使用大模型分析数据
- **自动化执行**：多步任务自动规划执行

#### 网络对战系统
- **房间系统**：创建和加入对战房间
- **攻击系统**：多种攻击技能和模式
- **战斗机制**：生命值、无敌帧、击退效果
- **移动控制**：点击移动和键盘控制
- **实时同步**：所有数据实时同步

---

## 🛠️ 技术架构

### 后端技术栈
- **Python 3.8+**：主要开发语言
- **Flask**：Web框架
- **PyQt6**：桌面应用框架
- **OpenManus**：AI工具链核心
- **Ollama**：本地大模型服务
- **DeepSeek**：大语言模型

### 前端技术栈
- **HTML5/CSS3**：现代化Web界面
- **JavaScript**：交互逻辑
- **Bootstrap**：响应式设计
- **Chart.js**：数据可视化

### AI与机器学习
- **OpenCV**：计算机视觉
- **MediaPipe**：手势识别
- **PyTorch**：深度学习框架
- **NumPy/Pandas**：数据处理

### 数据存储
- **JSON**：配置文件和数据存储
- **SQLite**：轻量级数据库
- **文件系统**：图片和模型存储

---

## 📦 安装部署

### 完整安装步骤

#### 1. 环境准备
```bash
# 创建虚拟环境（推荐）
python -m venv eye_health_env
source eye_health_env/bin/activate  # Linux/Mac
# 或
eye_health_env\Scripts\activate     # Windows

# 升级pip
pip install --upgrade pip
```

#### 2. 安装依赖
```bash
# 安装主项目依赖
pip install -r requirements.txt

# 安装桌宠依赖
cd PepperCat-main
pip install -r requirements.txt
cd ..
```

#### 3. 配置系统
```bash
# 编辑配置文件
vim config/config.toml
```

配置文件示例：
```toml
[model]
type = "ollama"
model_name = "deepseek-chat"
base_url = "http://localhost:11434"

[web]
host = "127.0.0.1"
port = 5000
debug = true

[pet]
enable_eye_games = true
enable_battle = true
```

#### 4. 部署大模型
```bash
# 安装Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 下载模型
ollama pull deepseek-chat

# 启动服务
ollama serve
```

#### 5. 验证安装
```bash
# 测试Web端
python start_web_app.py

# 测试桌宠端
cd PepperCat-main
python main.py
```

---

## 📖 使用指南

### Web端使用

#### 1. 启动Web应用
```bash
python start_web_app.py
```

#### 2. 访问界面
打开浏览器访问：http://localhost:5000

#### 3. 主要功能使用

**智能对话**：
- 在聊天框中输入问题
- 系统会自动识别需求并调用相应工具
- 支持多轮对话和上下文理解

**视力检测**：
- 点击"视力检测"按钮
- 按照提示进行检测
- 支持手势控制和语音提示

**训练游戏**：
- 选择游戏类型
- 按照游戏规则进行训练
- 查看训练结果和统计

**数据分析**：
- 查看历史检测数据
- 分析视力变化趋势
- 生成个性化报告

### 桌宠端使用

#### 1. 启动桌宠
```bash
cd PepperCat-main
python main.py
```

#### 2. 基础交互
- **右键菜单**：访问各种功能
- **左键点击**：与桌宠互动
- **拖拽**：移动桌宠位置

#### 3. 眼部健康游戏
- **启动游戏**：右键 → 聊天 → 输入"我想玩眼部健康游戏"
- **游戏类型**：
  - "启动记忆训练游戏"
  - "进行专注力训练"
  - "启动反应速度训练游戏"

#### 4. AI工具链
- **智能对话**：右键 → 聊天 → 输入自然语言命令
- **示例命令**：
  - "查天气并保存到文件"
  - "读取数据文件并分析"
  - "画一个折线图"

#### 5. 网络对战
- **创建房间**：右键 → 对战 → 创建房间
- **加入房间**：输入服务器IP加入对战
- **战斗操作**：使用攻击按钮和移动控制

---

## 🖼️ 独立图片分析与AI健康报告（桌宠端/全局通用）

## 功能简介

- **无需Web端，桌宠端可直接检测图片**，本地推理，自动生成健康建议。
- 支持通过自然语言命令直接分析本地图片，并自动调用大模型（DeepSeek）生成详细健康报告。
- 支持图片分类概率输出、健康建议、预防措施、就医建议等。

## 使用方法

### 1. 聊天对话框直接分析图片

- 启动桌宠端：  
  ```bash
  cd PepperCat-main
  python main.py
  ```
- 在桌宠聊天框输入：
  ```
  分析图片pictures/glaucoma_classification_1.png
  ```
  或
  ```
  检测桌面上的眼部图片
  ```
- 桌宠会自动调用本地模型进行图片分析，并用DeepSeek生成详细健康报告，无需Web服务。

### 2. 命令行独立测试

- 运行测试脚本（无需Web端）：
  ```bash
  cd PepperCat-main
  python test_standalone_image_analysis.py
  ```
- 你会看到类似如下输出：
  ```
  图片分析完成！

  检测结果显示：糖尿病

  置信度：80.55%

  健康建议：
  • 建议尽快到专业眼科医院进行详细检查
  • 请遵医嘱进行治疗和护理
  • 定期复查，监测病情变化
  • 保持良好的生活习惯，避免加重病情
  • 如有不适，请及时就医
  ```

### 3. 支持的自然语言命令示例

- “分析图片pictures/xxx.png”
- “检测桌面上的眼部图片”
- “请帮我分析这张眼底照片”
- “生成详细的健康报告”

## 技术说明

- **模型文件**：`oct_scripted.pt`（或`best_model.pth`），需放在项目根目录
- **图片路径**：支持相对路径、绝对路径、桌面路径
- **AI健康报告**：自动调用DeepSeek大模型生成，内容包括检测结果、置信度、健康建议、预防措施、就医建议等
- **无需Web服务**：完全本地推理，适合离线环境

## 常见问题

- **Q: 图片分析报错“模型未加载”**
  - 请确认`oct_scripted.pt`或`best_model.pth`已放在项目根目录
- **Q: DeepSeek报告无响应**
  - 请确认Ollama和DeepSeek模型已启动

---

## ❓ 常见问题

### 安装问题

**Q: 依赖安装失败**
```bash
# 解决方案
pip install --upgrade pip
pip install -r requirements.txt --force-reinstall
```

**Q: Ollama服务无法启动**
```bash
# 检查Ollama安装
ollama --version

# 手动启动服务
ollama serve
```

**Q: 模型下载失败**
```bash
# 检查网络连接
ping ollama.ai

# 手动下载模型
ollama pull deepseek-chat
```

### 运行问题

**Q: Web端无法访问**
- 检查端口是否被占用
- 确认防火墙设置
- 查看错误日志

**Q: 桌宠无法启动**
- 检查PyQt6安装
- 确认Python版本兼容性
- 查看控制台错误信息

**Q: 游戏无法启动**
- 检查tkinter安装
- 确认窗口权限
- 查看游戏日志

### 功能问题

**Q: AI对话无响应**
- 检查Ollama服务状态
- 确认模型已下载
- 查看网络连接

**Q: 视力检测不准确**
- 调整摄像头位置
- 确保光线充足
- 校准检测参数

**Q: 对战功能异常**
- 检查网络连接
- 确认防火墙设置
- 查看对战日志

---

## 🔧 开发指南

### 项目结构
```
eye_test_model-master/
├── 🌐 Web端
│   ├── eye_health_web_app.py     # Web应用主程序
│   ├── start_web_app.py          # 启动脚本
│   ├── templates/                # HTML模板
│   ├── vision_test.py            # 视力检测
│   ├── vision_training_game.py   # 训练游戏
│   └── vision_analytics.py       # 数据分析
│
├── 🐱 桌宠端
│   ├── PepperCat-main/
│   │   ├── main.py               # 桌宠主程序
│   │   ├── src/
│   │   │   ├── tools/            # 工具模块
│   │   │   ├── ui/               # 界面模块
│   │   │   └── agent_manager.py  # 代理管理
│   │   └── test_eye_games.py     # 游戏测试
│   └── EYE_HEALTH_README.md      # 桌宠说明
│
├── 🤖 AI核心
│   ├── eye_health_agent_integrated.py  # 智能代理
│   ├── eye_health_llm.py               # 大模型系统
│   ├── openmanus_core/                 # OpenManus核心
│   └── config/                         # 配置文件
│
└── 📊 数据与模型
    ├── user_memory.json           # 用户数据
    ├── game_history.json          # 游戏历史
    ├── best_model.pth             # 训练模型
    └── analytics_reports/         # 分析报告
```

### 开发环境设置
```bash
# 克隆项目
git clone <repository-url>
cd eye_test_model-master

# 创建开发分支
git checkout -b feature/new-feature

# 安装开发依赖
pip install -r requirements.txt
pip install pytest black flake8

# 运行测试
pytest tests/

# 代码格式化
black .
flake8 .
```

### 添加新功能

#### 添加新的视力检测
1. 在`vision_test.py`中添加检测逻辑
2. 在Web界面中添加对应按钮
3. 更新API接口
4. 添加测试用例

#### 添加新的训练游戏
1. 在`vision_training_game.py`中实现游戏逻辑
2. 在桌宠端`eye_games.py`中添加游戏类
3. 更新工具注册和命令解析
4. 添加游戏测试

#### 添加新的AI工具
1. 在`openmanus_core`中实现工具类
2. 注册到工具集合中
3. 更新MCP提示词
4. 添加使用示例

### 贡献指南
1. Fork项目
2. 创建功能分支
3. 提交代码
4. 创建Pull Request

---

## 📄 许可证

本项目采用MIT许可证，详见[LICENSE](LICENSE)文件。

---

## 🙏 致谢

- **OpenManus团队**：提供优秀的AI工具链框架
- **DeepSeek团队**：提供强大的大语言模型
- **Ollama团队**：提供本地大模型部署方案
- **开源社区**：所有贡献者和用户

---

## 📞 联系我们

- **项目地址**：[GitHub Repository](https://github.com/your-repo)
- **问题反馈**：[Issues](https://github.com/your-repo/issues)
- **功能建议**：[Discussions](https://github.com/your-repo/discussions)

---

*让眼部健康管理变得简单、智能、有趣！* 🏥✨

